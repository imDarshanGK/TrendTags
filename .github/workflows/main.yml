name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for proper git history in tests

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'  # Enable caching for faster builds

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          fi

      - name: Lint Python Code
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --statistics

      - name: Run Python Tests
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pip install pytest pytest-cov
            pytest --cov=./ --cov-report=xml
          else
            echo "No tests found, skipping"
          fi

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        if: success()

      - name: Verify Frontend Files
        run: |
          if [ ! -f "templates/index.html" ]; then
            echo "::error::Missing index.html in templates directory"
            exit 1
          fi
          if [ ! -f "static/css/style.css" ]; then
            echo "::warning::Missing style.css in static/css directory"
          fi

      - name: Build Success
        if: success()
        run: echo "ðŸŽ‰ CI Pipeline completed successfully!"
